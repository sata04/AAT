# AAT ユーザーマニュアル

## 目次

1. [はじめに](#はじめに)
2. [インストールと起動](#インストールと起動)
3. [画面構成](#画面構成)
4. [基本操作](#基本操作)
5. [高度な機能](#高度な機能)
6. [設定のカスタマイズ](#設定のカスタマイズ)
7. [データの読み込みと処理](#データの読み込みと処理)
8. [グラフの操作](#グラフの操作)
9. [統計情報の確認](#統計情報の確認)
10. [G-quality解析](#g-quality解析)
11. [結果のエクスポート](#結果のエクスポート)
12. [トラブルシューティング](#トラブルシューティング)
13. [FAQ](#faq)

---

## はじめに

AAT (Acceleration Analysis Tool) は、微小重力環境での実験データを分析するための専用ツールです。このマニュアルでは、AATの使い方を詳しく説明します。

### 対象ユーザー

- 微小重力実験の研究者
- 実験データの解析担当者
- 宇宙環境実験に関わる技術者

### 必要な知識

- 基本的なPCの操作方法
- CSVファイル形式の理解
- 微小重力実験の基礎知識（推奨）

---

## インストールと起動

### システム要件

- **OS**: Windows 10/11、macOS 10.15以降、Linux (Ubuntu 20.04以降)
- **Python**: 3.9以降
- **メモリ**: 4GB以上（8GB推奨）
- **ディスク容量**: 500MB以上の空き容量

### インストール手順

1. **Pythonのインストール確認**
   ```bash
   python --version
   ```
   Python 3.9以降がインストールされていることを確認してください。

2. **AATのダウンロード**
   ```bash
   git clone https://github.com/sata04/AAT.git
   cd AAT
   ```

3. **仮想環境の作成と依存関係のインストール（uv推奨）**
   ```bash
   uv venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   uv pip install -e ".[dev]"
   ```

### アプリケーションの起動

```bash
uv run python main.py
```

起動オプション：
- `--verbose` または `-v`: 詳細ログを表示
- `--debug`: デバッグモードで起動
- `AAT_DEBUG=1 uv run python main.py`: 環境変数でデバッグモード指定

---

## 画面構成

### メインウィンドウ

AATのメインウィンドウは以下の要素で構成されています：

1. **メニューバー**
   - ファイル: CSVファイルの選択、終了
   - 編集: 列選択ダイアログの表示
   - 表示: テーマ切替、比較モード、全体表示、キャッシュクリア
   - ヘルプ: バージョン情報

2. **ツールバー**
   - CSVファイル選択ボタン
   - 列選択ボタン
   - 設定ボタン
   - G-quality評価モード切替ボタン

3. **グラフ表示エリア**
   - 上部: Inner Capsule重力レベルグラフ
   - 下部: Drag Shield重力レベルグラフ

4. **統計情報テーブル**
   - 各データセットの統計情報を表示

5. **ステータスバー**
   - 処理状況、進捗状況を表示

6. **テーマ設定**
   - メニューバー「表示」>「テーマ」から、ダークモード/ライトモード/システムデフォルトを選択可能
   - ヘッダー右上のバッジで現在のテーマ状態を確認可能

7. **ステータスバッジ**
   - ヘッダー右上に現在の状態（ファイル数、モード、表示範囲、テーマ）を表示

---

## 基本操作

### 1. CSVファイルの選択

- メインウィンドウの「CSVファイルを選択」ボタンをクリックし、ダイアログでCSVを選択
- Ctrl/Cmd + クリックで複数ファイルを選択可能（選択した順に処理）
- 現行バージョンはドラッグ&ドロップによる読み込みに対応していません

### 2. 列の自動検出と手動選択

#### 自動検出
AATは以下のキーワードを含む列を自動検出します：
- 時間列: "時間", "time", "Time"
- 加速度列: "acceleration", "加速度", "acc"

#### 手動選択
自動検出が失敗した場合：
1. 「列選択」ボタンをクリック
2. 列選択ダイアログで適切な列を選択
3. 「OK」をクリック

### 3. データの処理と表示

データ読み込み後、自動的に以下の処理が実行されます：
1. 同期点の検出
2. 重力レベルへの変換
3. グラフの描画
4. 統計情報の計算

---

## 高度な機能

### グラフのインタラクティブ操作

#### ズーム
- **マウスホイール**: グラフの拡大/縮小
- **右クリックドラッグ**: 矩形選択でズーム
- **ダブルクリック**: ズームリセット

#### パン
- **左クリックドラッグ**: グラフの移動
- **中クリックドラッグ**: 高速移動

#### 範囲選択と統計表示
1. グラフ上で左クリックしてドラッグ
2. 選択範囲がハイライト表示
3. マウスを離すと統計情報ダイアログが表示
4. 表示される統計情報：
   - 平均値
   - 絶対値の平均
   - 標準偏差
   - 最小値/最大値
   - データ点数

### キャッシュ機能

#### キャッシュの仕組み
- 処理済みデータは自動的にキャッシュ
- 同じファイル・同じ設定での再読み込みが高速化
- キャッシュは`results_AAT/cache/`に保存

#### キャッシュのクリア
1. メニューバー → 表示 → キャッシュクリア
2. 確認ダイアログで「はい」を選択
3. すべてのキャッシュファイルが削除

---

## 設定のカスタマイズ

### 設定ダイアログの開き方

1. ツールバーの「設定」ボタンをクリック
2. または、メニューバー → 編集 → 設定
3. 各種設定項目はトグルスイッチや入力フィールドで直感的に変更可能

### 主要な設定項目

#### データ処理設定

| 設定項目 | 説明 | デフォルト値 | 推奨範囲 |
|---------|------|-------------|----------|
| サンプリングレート | データの取得頻度 | 1000 Hz | 100-10000 Hz |
| 重力定数 | 基準重力加速度 | 9.797578 m/s² | 9.7-9.9 m/s² |
| 加速度閾値 | 同期点検出の閾値 | 5.0 m/s² | 0.5-6.0 m/s² |
| 終了重力レベル | `gravity_level` の終了条件 (G) | 8.0 G | 5-20 G |
| Inner加速度の反転 | Inner Capsuleの符号補正 | 有効 | 必要に応じて |

#### 表示設定

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| Y軸最小値 | グラフの表示範囲下限 | -1.0 G |
| Y軸最大値 | グラフの表示範囲上限 | 1.0 G |

#### 統計解析設定

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| ウィンドウサイズ | 統計計算の時間窓 | 0.1 秒 |
| 開始後最小秒数 | 解析開始までの待機時間 | 0.7 秒 |

#### G-quality設定

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| 開始ウィンドウ | G-quality解析の最小窓 | 0.1 秒 |
| 終了ウィンドウ | G-quality解析の最大窓 | 1.0 秒 |
| ステップサイズ | ウィンドウ増加量 | 0.05 秒 |
| 自動計算 | ファイル読込時の自動実行 | ON |
| Inner加速度の反転 | Inner Capsuleの符号を反転 | ON |

#### エクスポート設定

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| 図の幅 | エクスポートするグラフ画像の幅 (インチ) | 10.6 |
| 図の高さ | エクスポートするグラフ画像の高さ (インチ) | 3.4 |
| DPI | 画像の解像度 (Dots Per Inch) | 300 |
| 境界設定 | 余白の自動調整 (tight/固定) | 固定 |

#### グラフ表示設定

| 設定項目 | 説明 | デフォルト値 |
|---------|------|-------------|
| 表示センサー | グラフに表示するセンサー (両方/Innerのみ/Dragのみ) | 両方 |

### 設定の保存と読み込み

- 設定は自動的にユーザー設定ディレクトリに保存（mac: `~/Library/Application Support/AAT/config.json`、Windows: `%APPDATA%\\AAT\\config.json`、Linux/WSL: `$XDG_CONFIG_HOME/AAT/config.json`）
- アプリケーション起動時に自動読み込み
- 保存場所を変えたい場合は環境変数`AAT_CONFIG_DIR`で上書き可能
- 旧仕様の`./config.json`が残っている場合も初回読み込み時に自動移行

---

## データの読み込みと処理

### CSVファイルの要件

#### 必須列
1. **時間列**: 秒単位の時間データ
2. **Inner Capsule加速度列**: Z軸加速度データ (m/s²)
3. **Drag Shield加速度列**: Z軸加速度データ (m/s²)

#### ファイル形式
- エンコーディング: UTF-8推奨（pandasが自動判別できる場合はその他のエンコーディングも読み込めることがあります）
- 区切り文字: カンマ（,）
- ヘッダー行: 必須

### データ処理の流れ

1. **ファイル読み込み**
   - CSVファイルの解析
   - 列の自動検出

2. **同期点検出**
   - 加速度が閾値未満になる最初の点を検出
   - 時間軸の調整（t=0に設定）

3. **重力レベル変換**
   - 加速度データを重力レベル（G）に変換
   - 計算式: `gravity_level = acceleration / gravity_constant`

4. **データフィルタリング**
   - t=0から終了重力レベルまでのデータを抽出
   - 無効なデータの除外

5. **統計計算**
   - 指定ウィンドウサイズでの最小標準偏差区間を検出
   - 各種統計値の計算

---

## グラフの操作

### グラフの構成

各グラフには以下の要素が表示されます：
- **青線**: 重力レベルの時系列データ
- **赤破線**: ゼロライン
- **黄色領域**: 最小標準偏差区間（統計計算済みの場合）
- **緑縦線**: データ終了点

### グラフツールバー

各グラフの下部にあるツールバーボタン：
- **ホーム**: 初期表示にリセット
- **戻る/進む**: 表示履歴の移動
- **パン**: グラフ移動モード
- **ズーム**: 拡大モード
- **設定**: グラフ設定の調整
- **保存**: グラフを画像として保存

### カスタマイズ可能な要素

- 線の太さ
- 色の変更
- グリッドの表示/非表示
- 軸ラベルのフォントサイズ

---

## 統計情報の確認

### 統計情報テーブル

メインウィンドウ下部のテーブルに表示される情報：

| 項目 | 説明 | 単位 |
|------|------|------|
| データセット | Inner Capsule / Drag Shield | - |
| 平均値（絶対値） | 最小標準偏差区間の絶対値平均 | G |
| 開始時間 | 最小標準偏差区間の開始時刻 | 秒 |
| 最小標準偏差 | ウィンドウ内の最小標準偏差値 | G |

### 詳細統計情報

グラフ上で範囲選択した際に表示される情報：
- 選択範囲の時間
- データ点数
- 平均値（符号付き）
- 絶対値の平均
- 標準偏差
- 最小値/最大値
- 範囲（最大値-最小値）

---

## G-quality解析

### G-quality解析とは

微小重力環境の品質を多角的に評価する機能です。異なるウィンドウサイズで標準偏差を計算し、時間スケールに対する安定性を評価します。

### 実行方法

#### 自動実行（推奨）
- 設定で「G-quality自動計算」をONにする
- CSVファイル読み込み時に自動的に実行

#### 手動実行
1. ツールバーの「G-quality評価モード」をクリック
2. または、メニューバー「解析」>「G-quality評価モード」を選択

### 解析パラメータ

- **開始ウィンドウ**: 0.1秒（最小評価単位）
- **終了ウィンドウ**: 1.0秒（最大評価単位）
- **ステップ**: 0.05秒（ウィンドウ増分）

### 結果の見方

G-qualityグラフの読み方：
- **X軸**: ウィンドウサイズ（秒）
- **Y軸**: 各ウィンドウでの最小標準偏差（G）
- **青線**: Inner Capsuleの結果
- **赤線**: Drag Shieldの結果

理想的な微小重力環境では、すべてのウィンドウサイズで低い標準偏差を示します。

---

## 結果のエクスポート

### 自動保存される内容

データ処理が完了すると、以下のファイルが自動的に作成されます：

#### Excelファイル
場所: `{CSVファイルのディレクトリ}/results_AAT/{ファイル名}.xlsx`

含まれるシート：
1. **Gravity Level Data**: 時系列データ
2. **Gravity Level Statistics**: 統計情報サマリー
3. **Acceleration Data**: 元の加速度データ
4. **G-quality Analysis**: G-quality解析結果（実行時のみ）

#### グラフ画像
場所: `{CSVファイルのディレクトリ}/results_AAT/graphs/`

- `{ファイル名}_gl.png`: 重力レベルグラフ
- `{ファイル名}_gq.png`: G-qualityグラフ（実行時のみ）

### 手動エクスポート

グラフの個別保存：
1. グラフツールバーの「保存」ボタンをクリック
2. ファイル形式を選択（PNG, PDF, SVG等）
3. 保存先を指定

---

## トラブルシューティング

### よくある問題と解決法

#### アプリケーションが起動しない

**症状**: `uv run python main.py`実行時にエラー

**解決法**:
1. Pythonバージョンを確認
   ```bash
   python --version
   ```
2. 仮想環境を作り直し、依存関係を再インストール
   ```bash
   rm -rf .venv
   uv venv
   source .venv/bin/activate  # Windows: .venv\Scripts\activate
   uv pip install -e ".[dev]"
   ```

#### CSVファイルが読み込めない

**症状**: 「列が見つかりません」エラー

**解決法**:
1. CSVファイルをテキストエディタで開き、列名を確認
2. 列選択ダイアログで手動選択
3. エンコーディングを確認（UTF-8推奨）

#### グラフが表示されない

**症状**: データ読み込み後、グラフエリアが空白

**解決法**:
1. Y軸の表示範囲を確認（設定で調整）
2. データに異常値がないか確認
3. キャッシュをクリアして再読み込み

#### 処理が遅い

**症状**: 大きなファイルの処理に時間がかかる

**解決法**:
1. キャッシュ機能を有効にする
2. 不要なアプリケーションを終了
3. データを分割して処理

#### macOSでの警告メッセージ

**症状**: 「CoreText note:...」などの警告

**解決法**:
- 機能に影響はありません
- デバッグ情報が必要な場合：
  ```bash
  AAT_DEBUG=1 uv run python main.py
  ```

### エラーメッセージの対処法

| エラーメッセージ | 原因 | 対処法 |
|----------------|------|--------|
| "ColumnNotFoundError" | 必要な列が見つからない | 列選択ダイアログで手動指定 |
| "SyncPointNotFoundError" | 同期点が検出できない | 加速度閾値を調整 |
| "InsufficientDataError" | データ点数が不足 | より長い時間のデータを使用 |
| "Permission denied" | ファイルアクセス権限なし | ファイルの権限を確認 |

---

## FAQ

### Q: 対応しているCSVファイルの最大サイズは？
A: 理論上の制限はありませんが、メモリに依存します。8GBのメモリで約1GBのCSVファイルまで快適に処理できます。

### Q: 複数のCSVファイルを一度に処理できますか？
A: はい、ファイル選択ダイアログで複数選択できます（ドラッグ&ドロップには対応していません）。

### Q: 設定を別のPCに移行するには？
A: 上記のユーザー設定ディレクトリにある`config.json`をコピーしてください。新しいPCでも同じ場所（または`AAT_CONFIG_DIR`で指定した場所）に配置すれば設定が反映されます。

### Q: グラフの色を変更できますか？
A: テーマ（ダーク/ライト）を切り替えることで、グラフの背景色や軸の色を変更できます。個々の線の色を変更するには、現在のバージョンではコード修正が必要です。

### Q: データの単位を変更できますか？
A: 重力レベルの表示単位は G 固定です（加速度を重力定数で割った値）。現行バージョンでは μG への自動変換には対応していません。

### Q: キャッシュはどのくらいディスク容量を使用しますか？
A: 元のCSVファイルサイズの約2-3倍程度です。定期的なクリアを推奨します。

### Q: ダークモードとライトモードを切り替えるには？
A: メニューバーの「表示」>「テーマ」から「ダークモード」「ライトモード」「システムデフォルト」を選択できます。「システムデフォルト」を選ぶと、OSの設定に合わせて自動的に切り替わります。

### Q: G-quality解析の結果をカスタマイズできますか？
A: 設定ダイアログでウィンドウサイズの範囲とステップを調整できます。

### Q: ネットワークドライブ上のファイルを処理できますか？
A: 可能ですが、パフォーマンスが低下する可能性があります。ローカルにコピーしての処理を推奨します。

---

## 付録

### キーボードショートカット

| ショートカット | 機能 |
|--------------|------|
| Ctrl/Cmd + O | CSVファイルを開く |
| Ctrl/Cmd + , | 設定ダイアログを開く |
| Ctrl/Cmd + Q | アプリケーション終了 |
| Ctrl/Cmd + G | G-quality解析実行 |
| Ctrl/Cmd + R | 表示リセット |
| F5 | 再読み込み |

### ログファイルの場所

デバッグ情報は標準出力に表示されます。ファイルに保存する場合：

```bash
uv run python main.py --debug > aat_debug.log 2>&1
```

### サポート

- GitHubリポジトリ: https://github.com/sata04/AAT
- Issues: バグ報告、機能リクエスト
- Wiki: 追加のドキュメント、チュートリアル

---

最終更新日: 2025年11月22日
